name: Build and Release

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build:
    runs-on: windows-latest

    steps:
    - uses: actions/checkout@v4
      with:
        submodules: false

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.12'

    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~\AppData\Local\pip\Cache
        key: ${{ runner.os }}-pip-${{ hashFiles('**/requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-

    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    - name: Install Inno Setup
      run: choco install innosetup -y

    - name: Build application
      run: python build.py --no-tests

    - name: Verify build artifacts
      run: |
        if (!(Test-Path "dist/Digital Workshop.exe")) {
          Write-Error "Executable not found after build"
          exit 1
        }
        Write-Host "✓ Executable created successfully"

        # List all artifacts in dist directory
        Write-Host "`nBuild artifacts:"
        Get-ChildItem -Path "dist" -File | ForEach-Object { Write-Host "  - $($_.Name) ($([math]::Round($_.Length / 1MB, 2)) MB)" }

    - name: Create portable archive
      run: |
        # Create portable ZIP archive
        $SourceDir = "dist"
        $DestZip = "dist/Digital-Workshop-v0.1.5-Portable.zip"

        # Create ZIP with portable executable
        Compress-Archive -Path "$SourceDir/Digital Workshop.exe" -DestinationPath $DestZip -Force
        Write-Host "✓ Portable archive created: $DestZip"

        # List the archive
        Get-ChildItem -Path $DestZip | ForEach-Object { Write-Host "  Size: $([math]::Round($_.Length / 1MB, 2)) MB" }

    - name: Create source archive
      run: |
        # Create source code archive (excluding build artifacts and cache)
        $SourceZip = "dist/Digital-Workshop-v0.1.5-Source.zip"

        # Create ZIP with source code
        $ExcludePatterns = @('dist', 'build', '.git', '__pycache__', '*.pyc', '.pytest_cache', 'node_modules', '.venv', 'venv')

        # Use PowerShell to create archive excluding patterns
        $files = Get-ChildItem -Path "." -Recurse -File | Where-Object {
          $path = $_.FullName
          -not ($ExcludePatterns | Where-Object { $path -like "*\$_\*" -or $path -like "*\$_" })
        }

        Compress-Archive -Path ($files | Select-Object -ExpandProperty FullName) -DestinationPath $SourceZip -Force
        Write-Host "✓ Source archive created: $SourceZip"

        # List the archive
        Get-ChildItem -Path $SourceZip | ForEach-Object { Write-Host "  Size: $([math]::Round($_.Length / 1MB, 2)) MB" }

    - name: Create Windows installer
      run: |
        # Create Windows installer using Inno Setup
        $InnoSetupPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
        $InstallerScript = "config/installer.iss"

        if (Test-Path $InnoSetupPath) {
          Write-Host "Creating Windows installer..."
          & $InnoSetupPath $InstallerScript

          # Move installer to dist directory with proper naming
          if (Test-Path "config/Output/mysetup.exe") {
            Copy-Item -Path "config/Output/mysetup.exe" -Destination "dist/Digital-Workshop-v0.1.5-Setup.exe" -Force
            Write-Host "✓ Windows installer created: dist/Digital-Workshop-v0.1.5-Setup.exe"
            Get-ChildItem -Path "dist/Digital-Workshop-v0.1.5-Setup.exe" | ForEach-Object { Write-Host "  Size: $([math]::Round($_.Length / 1MB, 2)) MB" }
          } else {
            Write-Warning "Installer creation failed - installer file not found"
          }
        } else {
          Write-Warning "Inno Setup not found at $InnoSetupPath"
        }

    - name: Upload artifacts to release
      uses: softprops/action-gh-release@v1
      if: github.event_name == 'release'
      with:
        files: |
          dist/Digital Workshop.exe
          dist/Digital-Workshop-v0.1.5-Setup.exe
          dist/Digital-Workshop-v0.1.5-Portable.zip
          dist/Digital-Workshop-v0.1.5-Source.zip
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Upload artifacts as workflow artifacts
      if: github.event_name == 'workflow_dispatch'
      uses: actions/upload-artifact@v4
      with:
        name: Digital-Workshop-Build
        path: |
          dist/Digital Workshop.exe
          dist/Digital-Workshop-v0.1.5-Setup.exe
          dist/Digital-Workshop-v0.1.5-Portable.zip
          dist/Digital-Workshop-v0.1.5-Source.zip
        retention-days: 30
