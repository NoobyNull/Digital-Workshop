# Digital Workshop â€“ GitLab CI configuration for Windows EXE builds

stages:
  - build

variables:
  PIP_CACHE_DIR: "$CI_PROJECT_DIR/.cache/pip"
  BUILD_NUMBER: "$CI_PIPELINE_IID"
  RUN_TESTS: "false"
  WINDOWS_PYTHON_VERSION: "3.11.6"
  WINDOWS_RUNNER_TAGS: "windows,digital-workshop,pyinstaller"
  DIST_DIR: "dist"
  EXE_NAME: "Digital Workshop"
  PYTHONUTF8: "1"
  PYTHONIOENCODING: "utf-8"
  PYTHONUNBUFFERED: "1"

cache:
  key: "$CI_COMMIT_REF_SLUG-windows"
  paths:
    - .cache/pip/

build_windows_exe:
  stage: build
  tags:
    - windows
    - digital-workshop
    - pyinstaller
  timeout: 2h
  script: |
    Set-StrictMode -Version Latest
    $ErrorActionPreference = "Stop"
    $ProgressPreference = "SilentlyContinue"
    chcp 65001 | Out-Null

    function Ensure-Python {
      param([string]$Version)
      if (Get-Command python -ErrorAction SilentlyContinue) {
        return
      }
      if (-not (Get-Command choco -ErrorAction SilentlyContinue)) {
        throw "Python is not installed and Chocolatey is unavailable on this runner."
      }
      Write-Host "Installing Python $Version via Chocolatey..."
      choco install python --version $Version -y --no-progress
      $pythonInstall = Get-ChildItem -Directory "C:\Python*" | Sort-Object LastWriteTime -Descending | Select-Object -First 1
      if ($pythonInstall) {
        $env:Path = "$($pythonInstall.FullName);$($pythonInstall.FullName)\Scripts;$env:Path"
      }
    }

    function Ensure-File {
      param([string]$Path)
      if (-not (Test-Path $Path)) {
        Set-Content -Path $Path -Value "{}" -Encoding utf8
      }
    }

    Ensure-Python -Version $Env:WINDOWS_PYTHON_VERSION
    python --version
    python -m pip --version

    Write-Host "== Installing dependencies =="
    python -m pip install --upgrade pip setuptools wheel
    python -m pip install -r requirements.txt -r requirements-dev.txt
    python -m pip install openai anthropic google-generativeai zhipuai python-dotenv requests qdarkstyle
    python -m pip install bandit safety semgrep

    Write-Host "== Running security scans =="
    python -m safety check --json --output safety-report.json
    python -m bandit -r src/ -f json -o bandit-report.json
    semgrep --config=auto --json --output=semgrep-report.json src/

    Write-Host "== Applying automated security fixes =="
    python scripts/auto_security_fix.py --project-root .
    Ensure-File -Path "security-fixes.json"

    if ("$Env:RUN_TESTS" -eq "true") {
      Write-Host "== Running pytest suite =="
      python -m pytest --junitxml junit.xml
    }

    Write-Host "== Building Windows executable via PyInstaller =="
    python build_exe.py

    $buildNumber = $Env:CI_PIPELINE_IID
    if (-not $buildNumber) { $buildNumber = "local" }

    $distDir = if ($Env:DIST_DIR) { $Env:DIST_DIR } else { "dist" }
    $exeBaseName = if ($Env:EXE_NAME) { $Env:EXE_NAME } else { "Digital Workshop" }
    $exePath = Join-Path $distDir "$exeBaseName.exe"
    if (-not (Test-Path $exePath)) { Write-Error "EXE not found at $exePath" }

    $versionedName = "$exeBaseName.$buildNumber.exe"
    $versionedExePath = Join-Path $distDir $versionedName
    Rename-Item -Path $exePath -NewName $versionedName -Force

    $latestExePath = Join-Path $distDir "$exeBaseName.latest.exe"
    Copy-Item -Path $versionedExePath -Destination $latestExePath -Force

    python scripts/generate_changelog.py --build-number $buildNumber --output (Join-Path $distDir "changes-$buildNumber.txt")

    $infoPath = Join-Path $distDir "build-info.txt"
    Set-Content -Path $infoPath -Value "Build: $buildNumber" -Encoding utf8
    Add-Content -Path $infoPath -Value "Commit: $Env:CI_COMMIT_SHA" -Encoding utf8
    Add-Content -Path $infoPath -Value "Pipeline: $Env:CI_PIPELINE_URL" -Encoding utf8
    Add-Content -Path $infoPath -Value "Branch: $Env:CI_COMMIT_REF_NAME" -Encoding utf8
    Add-Content -Path $infoPath -Value "Runner: $Env:CI_RUNNER_DESCRIPTION" -Encoding utf8
    Add-Content -Path $infoPath -Value "Timestamp: $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')" -Encoding utf8

    $releaseInfoPath = Join-Path $distDir "release-$buildNumber.json"
    $releaseInfo = @{
      "buildNumber" = $buildNumber
      "commitSha" = $Env:CI_COMMIT_SHA
      "commitMessage" = "$(git log -1 --pretty=%s)"
      "commitAuthor" = "$(git log -1 --pretty=%an)"
      "branch" = $Env:CI_COMMIT_REF_NAME
      "pipelineUrl" = $Env:CI_PIPELINE_URL
      "timestamp" = $(Get-Date -Format 'yyyy-MM-dd HH:mm:ss UTC')
      "changesFile" = "changes-$buildNumber.txt"
    }
    $releaseInfo | ConvertTo-Json -Depth 3 | Out-File -FilePath $releaseInfoPath -Encoding utf8

    $hash = Get-FileHash -Algorithm SHA256 -Path $versionedExePath
    $hashLine = "{0}  {1}" -f $hash.Hash, (Split-Path -Leaf $hash.Path)
    Set-Content -Path (Join-Path $distDir "sha256.txt") -Value $hashLine -Encoding utf8

    $zipPath = Join-Path $distDir "$exeBaseName.$buildNumber.zip"
    if (Test-Path $zipPath) { Remove-Item $zipPath -Force }
    Compress-Archive -Path (Join-Path $distDir "*") -DestinationPath $zipPath -Force

    git config user.email "ci@digital-workshop.local"
    git config user.name "CI Builder"
    git fetch --tags --force
    git tag -f "build-$buildNumber" -m "Build $buildNumber"

    if ($Env:CI_JOB_TOKEN -and $Env:CI_SERVER_URL -and $Env:CI_PROJECT_PATH) {
      $remoteUri = New-Object System.UriBuilder("$($Env:CI_SERVER_URL.TrimEnd('/'))/$($Env:CI_PROJECT_PATH).git")
      $remoteUri.UserName = "gitlab-ci-token"
      $remoteUri.Password = $Env:CI_JOB_TOKEN
      git remote set-url origin $remoteUri.Uri.AbsoluteUri
    }

    git push origin "build-$buildNumber" 2>$null || Write-Host "Tag push failed (may already exist)"

  artifacts:
    name: "digital-workshop-build-$CI_PIPELINE_IID"
    when: always
    expire_in: never
    paths:
      - dist/
      - safety-report.json
      - bandit-report.json
      - semgrep-report.json
      - security-fixes.json
    reports:
      junit: junit.xml
      sast: bandit-report.json
      dependency_scanning: safety-report.json
      secret_detection: semgrep-report.json

  rules:
    - if: '$CI_COMMIT_BRANCH == "main"'
    - if: '$CI_COMMIT_BRANCH == "develop"'
    - if: '$CI_COMMIT_BRANCH =~ /^release\//'
    - if: '$CI_COMMIT_TAG'
    - if: '$CI_PIPELINE_SOURCE == "web"'
